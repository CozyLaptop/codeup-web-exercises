<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>MapBox Exercise API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="css/weather_map_style.css">

  </head>
  <body class="container-fluid">
    <div class="row no-gutters everything-container">
      <div class="col-7 mb-3">
        <form id="inputForm" class="centered">
          <input class="mt-2 form-control shadow" type="text" id="placeInput" placeholder="Enter a zipcode, city, state, etc.">
        </form>
        <div id="map" class="m-1"></div>
      </div>
      <div class="col-5 no-gutters card-col">
        <div class="card mt-1 mb-2 ml-2 mr-2 text-white bg-info text-center place">SAN ANTONIO, TX, UNITED STATES</div>
        <div class="row insert-cards"></div>
      </div>

<!--    -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script src='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.js'></script>
      <link href='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css' rel='stylesheet' />
      <script src="js/keys.js"></script>
<!--    -->
    <script>
      "use strict";
      var placeName;
      mapboxgl.accessToken = MAPBOX_API_TOKEN;

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        // Set map to San Antonio on start.
        center: [-98.491142, 29.424349] ,
        zoom: 10
      });

      var marker = new mapboxgl.Marker({
        draggable: true,
      })
              // Set marker to San Antonio on start
              .setLngLat([-98.49584979998528, 29.411475037661923])
              .addTo(map);

      $("#inputForm").submit(function (e){
        e.preventDefault();
        geocode($("#placeInput").val(), MAPBOX_API_TOKEN).then(function (data){
          console.log(data);
          var searchedLonLat = [data.features[0].center[0], data.features[0].center[1]];
          map.setCenter(searchedLonLat);
          map.setZoom(8);
          marker.setLngLat(searchedLonLat);
          var placeName = data.features[0].place_name;
          $(".place").html(placeName);
          refreshCards();
        });
      });

      marker.on('dragend', refreshCards);

      function refreshCards() {
        $(".insert-cards").html("");
        $.get('https://api.openweathermap.org/data/2.5/onecall', {
          appid: WEATHER_MAP_API_TOKEN,
          //San Antonio
          // lat: 29.4252,
          // lon: -98.4916,
          lat: marker.getLngLat().lat,
          lon: marker.getLngLat().lng,
          units: 'imperial'
        }).done(function (data) {
          data.daily.forEach(function (day, index) {
            var displayDay;

            if (index === 0) {
              displayDay = "Today";
            } else if (index === 1) {
              displayDay = "Tomorrow"
            } else {
              var dayOfWeek = new Date(day.dt * 1000);
              displayDay = (new Intl.DateTimeFormat('en-US', {weekday: 'long'}).format(dayOfWeek));
            }
            var card =
                    "          <div class=\"col-12 mb-2\">\n" +
                    "            <div class=\"card ml-2 mr-2 text-white bg-info\">\n" +
                    "               <h5 class='text-center m-1 font-weight-light'>" + displayDay + "</h5>" +
                    "               <div class=\"row\">\n" +
                    "                 <div class=\"col-6 text-center\">\n" +
                    "                   <h1 class=\"font-weight-bold\">" + day.temp.day + "&#730" + "F" + "</h1>\n" +
                    "                   <h5 class=\"font-weight-light\">" + day.weather[0].description + "</h5>\n" +
                    "                   </div>\n" +
                    "                   <div class=\"col-6 text-center mt-auto mb-auto\">\n" +
                    "                     <h6 class=\"mr-3 font-weight-light align-self-end\">" + "Humidity: " + day.humidity + "</h6>\n" +
                    "                     <h6 class=\"mr-3 font-weight-light align-self-end\">" + day.wind_speed + " mph" + "</h6>\n" +
                    "                     <h6 class=\"mr-3 align-self-end\">" + windCardinalDirection(day.wind_deg) +
                    "                     <h6 class=\"mr-3 font-weight-light align-self-end\">" + "Pressure: " + day.pressure + "</h6>\n" +
                    "                   </div>\n" +
                    "                 </div>\n" +
                    "            </div>\n" +
                    "          </div>"
            $(".insert-cards").append(card);
          });
        }).fail(function (error) {
          console.log(error);
        });
      }

      refreshCards();
      // Geocode and reverseGeocode functions
      function geocode(search, token) {
        var baseUrl = 'https://api.mapbox.com';
        var endPoint = '/geocoding/v5/mapbox.places/';
        return fetch(baseUrl + endPoint + encodeURIComponent(search) + '.json' + "?" + 'access_token=' + token)
                .then(function(res) {
                  return res.json();
                  // to get all the data from the request, comment out the following three lines...
                })
                // .then(function(data) {
                //   return data.features[0].center;
                // });
      }
      function reverseGeocode(coordinates, token) {
        var baseUrl = 'https://api.mapbox.com';
        var endPoint = '/geocoding/v5/mapbox.places/';
        return fetch(baseUrl + endPoint + coordinates.lng + "," + coordinates.lat + '.json' + "?" + 'access_token=' + token)
                .then(function(res) {
                  return res.json();
                })
                // to get all the data from the request, comment out the following three lines...
                .then(function(data) {
                  return data.features[0].place_name;
                });
      }
      //Functions for correct formatting of strings

      // This function takes a number between 0 and 360 and returns a
      // wind direction abbreviation. the MapBox API gives us a "wind degrees" datum
      // this takes the "wind degrees" and converts it into a familiar abbreviation

      function windCardinalDirection(degrees){
        let cardinalDirection = '';
        if ((degrees > 348.75 && degrees <= 360) || (degrees >=0 && degrees <= 11.25)){
          cardinalDirection = "N";
        } else if (degrees > 11.25 && degrees  <= 33.75) {
          cardinalDirection = "NNE";
        } else if (degrees > 33.75 && degrees <= 56.25) {
          cardinalDirection = "NE";
        } else if (degrees > 56.25 && degrees <= 78.75) {
          cardinalDirection = "ENE";
        } else if (degrees > 78.75 && degrees <= 101.25) {
          cardinalDirection = "E";
        } else if (degrees > 101.25 && degrees <= 123.75) {
          cardinalDirection = "ESE";
        } else if (degrees > 123.75 && degrees <= 146.25) {
          cardinalDirection = "SE";
        } else if (degrees > 146.25 && degrees <= 168.75) {
          cardinalDirection = "SSE";
        } else if (degrees > 168.75 && degrees <= 191.25) {
          cardinalDirection = "S";
        } else  if (degrees > 191.25 && degrees <= 213.75) {
          cardinalDirection = "SSW";
        } else if (degrees > 213.75 && degrees <= 236.25)  {
          cardinalDirection = "SW";
        } else if (degrees > 236.25 && degrees <= 258.75) {
          cardinalDirection = "WSW";
        } else if (degrees > 258.75 && degrees <= 281.25) {
          cardinalDirection = "W";
        } else if (degrees > 281.25 && degrees <= 303.75) {
          cardinalDirection = "WNW";
        } else if (degrees > 303.75 && degrees <= 326.25) {
          cardinalDirection = "NW";
        } else if (degrees > 326.75 && degrees <= 348.75) {
          cardinalDirection = "NNW";
        }
        return cardinalDirection;
      }
      function getTime(){
        var d = new Date( );
        d.setHours( d.getHours() + 2 ); // offset from local time
        var h = (d.getHours() % 12) || 12; // show midnight & noon as 12
        return (
                ( h < 10 ? '0' : '') + h +
                ( d.getMinutes() < 10 ? ':0' : ':') + d.getMinutes() +
                ( d.getHours() < 12 ? ' AM' : ' PM' )
        );
      }
      map.addControl(
              new MapboxGeocoder({
                accessToken: MAPBOX_API_TOKEN,
                mapboxgl: mapboxgl
              })
      );

    </script>
  </body>
</html>